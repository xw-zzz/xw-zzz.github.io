import{_ as A}from"./plugin-vue_export-helper-c27b6911.js";import{o as e,c as a,b as i}from"./app-ef0b4d9d.js";const r="/assets/image-20221019082836554-cb7a9937.png",t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABaMAAABECAIAAAATGL6vAAAMxklEQVR4nO3dvW6jwBbA8bNR3gMUJRI1L2ArzTaXwq0bpDRbIpdbIaqUCN1qm0g0tC6otonCC9DcBimryLzJLcCAP8A2JskY/3/Vbg5MZsDjwScz4x/39/cCAAAAAAAwCjffXQEAAAAAAIDBkOkAAAAAAADjQaYDAAAAAACMB5kOAAAAAAAwHjepbw1YnOWnwxb4pSw/XbvcRgAAAAAAcM2UmNNhOMt0w9IxTjx3NzNhOMuyGMs/ssB4YZqmabrJCXUHAAAAAAAKuf3uCqzl4XwWZKedY/mpp4dhIvZkN/iga7ISETHudFm9nlg0AAAAAAC4RErM6ejH8j1xzVnw0XrE6iOTIuUBAAAAAACuwq2IGM4ysotsQOKai7gKWn7qrWdLbM65aJyyc1Yz2memxrHihRnvDdS/fpKmXvEzL02fzqtLd5MBAAAAAIAKbmXiReKaZlx8lvd8Ky4+whvO8vHVNBciUuQ8Iv+j/HRv+ZG9cs3Z/o/6dYGWn3rPzt+j8guaHaV28c9zswhZMDMDw1k+y+9ZkBnOMtJfzs1LdDcZAAAAAACo4aaRV8iCl0Qmj+Xenlkwq7MD8ev2Lp3VcTvqAuPXRDT9YR1ofLXJ5q6jWTAzK24y8U7ZkrRFtWZluMUr7U0GAAAAAABq2N2RVL8zRDLZXq4hIlWyI16Y784yKpeGHL1CpXW5ydZR7mPq6Q9FJXqo19xMqmkiZy9e6dlkAAAAAADwpXZ3JC228TScZWRLOK9nWmweVU3DmIdiR+dPwWgw7vSzzo8XZX0T1zTNeZgX/zg7NfGJTQYAAAAAAMNoZjos35vk4Z963kWR9CgjLQVkf9/yIStkOM+2tlELWa97OTG5kK/e5VO+eWXoJgMAAAAAgKHcysSrvqAkqbfczILf4TTyqtUabqh766kWW8tazl/K0fyOF8nDubm/OG1zSctGNYpWVFUx7nSR1brE1fvp1Siavt5zZPAmAwAAAACAz/Dj/v7+u+sAAAAAAAAwjN19OgAAAAAAAC4VmQ4AAAAAADAeZDoAAAAAAMB4kOkAAAAAAADjQaYDAAAAAACMB5kOAAAAAAAwHmQ6AAAAAADAeJDpAAAAAAAA40GmA31ZfpqmS8fof7ZvDVsjYAwsP12jiwBf7byhbfACGSuBEXaiTx7oVWxyL4M3ZPACDWc56ICxNvhIdK1ump1t+4ISuvIQzqfIrSSkYKhNvDBN0zTd5Kijr5sit5KQgqEOo/kQ8NkUuZWEFAx1oH8dg4Eeg6Pr7XOTeno4N03TNOeh2FH9Xmb5hK46dFC8ME1zFmTHHn+FFLmVhBQM4XyK3EpCCobOMfjQdqFjpSK3kpCCoa93oZ0I6I3X/EBu8vB3eRmz4HeYa/YvS0TEcJ4mhK44hPMpcisJKRjC+RS5lYQUDOF8itxKQgqGAOBi3L79XaeLDOfZ1kTkzhCRn1MtJ3S9oe4couWn3qT4Z+Kai3gj8rSav+jR/njjRBGR5qS9Zqg6yXCWka3l4bzMahb/3/qdqjLUuJWEFAydkaMv+kD5n7pr7IREZKd7jgr9i9Dp/avZR7w09USk2Y3ahjbDWUb6W6jbtiZ5uB7hGofsHb86ClR/rKR/ERq2f3W+RLu6w+V2onO0vaVshTafAU5usqwv4uzj1zp8bINbCuy+KR0PMN3BOrZ9VodeBXZc+e7qbxxSBntejdNf8weGtutW7khq+WkaTd/cMBdNfxB50KvnZULXGOrWubxQsyNP3PUBk6f1dEfDWabrwNbJm6F5qHvlQrMsmJluotnPjiHlUHs5n90UuZWEFAz1ZflpZK/qntKYT2w4yzrkJjLuNIcocysJKRhqlwWzdQdJqsGofhbsGtom9vRtPg9zzY6eVnPTTWTyWP7tu2X8OlCg2mOlIreSkIKhdl3969BLtK07XHAn6qvrLcVwlo+vdbM0O1qH+jS5oNlR+rSaF7F84h3e6KG7wMZN2Siv4wFmO7i1amPiRfpL1eTno1ZR9Smws12dBVanR9O3+Uawz9U4/TV/YGi7bjfy4CzT4s7OgvfNIKErD/VTDw3xa1INjNYvW0vcvWOG8XOq5eGfdSgLXqpnSBGJF/NQ7Mj3/ciWcH5pn90UuZWEFAydynCeJtLoRMV84ulPQ6R4Lk1ey1D8J8xFv/u+NdVfRpFbSUjB0MDqifzJy8bfITvHr07qj5WK3EpCCob66HyJ7u8Oh6jfiU7WWcMsmNWVil/rj8K9myzNv/1nf98azw5WvSHtxp60hwqsb0oj1PkAU6yVar3era+Nthr2K7CrXQcK1OwoLbIcO+mF06/GAf16yhW7tb1pODcbNyZfvYvIKpcJoSsODc2400VW+2MPuiaaHaV284eNVGYWzFw99SaJa15SgvJdkVtJSMFQb5unZx8rsfUHkUzeV7nYj5bEsRTPPJJ8XFBvOR39i9CXjV9dDo1fp1JkrKR/EfqM/vU1j3OKdKKeumu4s0q1iJzTZFnVDwtZMDOD9X/ihbn3g/2pb3pV6qT1AeZB15q1OFpbDfsV2NWuAwXmofs29ezpTyPIDvzWw1cDw7qt/06xsTDzYyUihK43NLTso+UtuNQ1R9Bwlp4euuHUS325nAn5mSK3kpCCod60jYHQuNMlf6sHy0m1PnPkS1eE/kXoC8evQ4bsboqMlfQvQq2hM3zN45winegMLTU0nGVkS519svxyxD+ryUPWcK/VRyZiyIEHGP3MTcx29Cqwq12dBb4XKbJoKQc2xzjuamA4N/UCpWJRWjktM/4T5oSuOFQqZoYN8dVi8Wu9htJwls1dk+I/HSsDyzf230EczNxk4l3Q13QqcisJKRgqnda/ipmPXmPBbl2i8XOq1aszzbGnOUSUuZWEFAyVWvvX+yo/doXJQZ3jV68C1RgrFbmVhBQMlU7uX1/3OKdIJ+rn0FtKNbPA8pvt6tnkz6hhzfK9SbkepOsBZuvVNlAVTy6wq13HFBgvNrdO2Xbs1ehvyKFtPH7857//qyZCbaWymnOkCF1hSKoNgDs3tG6eafmpJ5t7Ztf/rc/Lw/lveY70l+rI7Ql5RYHFGTubcF/Q36sVuZWEFAzJ6f1rO9ryLQ97oiOlyK0kpGBIWvrX7onVIvXWrmc4y2j6Np8FUm78u4g3Brf949flj5WK3EpCCobk1P7V+RLt6A6X3onadA/0bW8pW1fWfZt6dbtOb7LsXMSjHfmmt3X1Wh9gdkrceFtuvcsnVPHIAlsvVHuB1fiQNQ5qvqZOvRp9X/PbdeS7Vwo/7u/vv7sOAIBz7Ix36+9iGXuuAwAAKKFv5mScuBoquPnuCgAAzmPc6Vs/+DnVvmF3RgAAAEAJt99dAQDAecrt4tf7kYpcxdoVAAAAoAWrVwAAAAAAwHiwegUAAAAAAIwHq1dK/97/tYXuH5j2AgAAAADAZWBOBwAAAAAAGA8yHQAAAAAAYDzIdAAAAAAAgPG4SX1rwOIsPx22QAAAAAAAgOMpMafDcJbphqVjnHjubnrFcJZlMZZ/SoEAAAAAAOByKfPdK3k4nwXZaedYfurpYZiIPdkNPuiarEREjDtdVq8nFg0AAAAAAC6REnM6+rF8T1xzFny0HrH6yKRIeQAAAAAAgKtwKyKGs4zsIhuQuOYiroKWn3rr2RKbcy4ap+yc1Yz2malxrHhhxnsD9a+fpKlX/MxL06dPrAsAAAAAAFDCjUy8SH8xTdM052E+8aoNLwxn+fhqltxEs6MqZPmRvXLNykaao1Ggm2j285E7ZGh2tN6l49wtTbNgZprzMM/DedEqSVzTNElzAAAAAAAwejeNCRlZ8JLI5LHMM2TBrM5gxK/J1onVcTvqAuPXRDT9YR2w/JZdR7NgVqdN3GTiDbCDaLVmhcUrAAAAAABcj90dSfU7QyST7RUqIlIlO+KF+e4so3JpyNErVFqXm2wd5T6mnv5QVKKHes3NJErt4mcsXgEAAAAA4Crs7khabONpOMvIlnBez7TYPKqahjEPxY4G/RJX404/6/x4UdY3cVm8AgAAAADAdWlmOizfm+Thn3reRZH0KCMtBWR/3/IhK2Q4z7a2UQtZr3s5MZ+Sr96FxSsAAAAAAFyVW5l41ReUJK45KzMMWfA7nEZetUDFDXVvPdVia1nL+d+v0vyOF8nDubm/OG1zSctGNYpWVFUx7nSR1brE1fs5tQMAAAAAABfjx/39/XfXQQn/3v+1he4fuEQAAAAAAFyG3X06AAAAAAAALhWZDgAAAAAAMB5kOgAAAAAAwHiwTwcAAAAAABgP5nQAAAAAAIDxINMBAAAAAADGg0wHAAAAAAAYDzIdAAAAAABgPMh0AAAAAACA8SDTAQAAAAAAxoNMBwAAAAAAGI//A1Ckl0ZJgvMKAAAAAElFTkSuQmCC",d="/assets/image-20221024230009818-9261266b.png",n="/assets/image-20221024230550721-758a37d6.png",o="/assets/image-20221024233646064-61a4ad3b.png",s="/assets/image-20221025000251739-62baa4ed.png",c={},l=i('<h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h2><p>Kafka中的消息是存储在磁盘上的，主要了解下面几点：</p><ul><li>为什么要使用磁盘作为存储介质</li><li>消息的存储格式</li><li>快速检索到指定的消息</li><li>消息不可能无限制存储，消息的清理规则</li><li>kafka高吞吐量原因</li></ul><h2 id="文件目录布局" tabindex="-1"><a class="header-anchor" href="#文件目录布局" aria-hidden="true">#</a> 文件目录布局</h2><p>Kafka 中的消息是以主题为基本单位进行归类的，各个主题在逻辑上相互独立。每个主题又可以分为一个或多个分区，分区的数量可以在主题创建的时候指定，也可以在之后修改。每条消息在发送的时候会根据分区规则被追加到指定的分区中，分区中的每条消息都会被分配一个唯一的序列号，也就是通常所说的偏移量。从存储结构来看，一个分区对应一个日志（Log）。为了防止 Log 过大，Kafka又引入了日志分段（LogSegment）的概念，将Log切分为多个LogSegment，相当于一个巨型文件被平均分配为多个相对较小的文件，这样也便于消息的维护和清理。日志以文件夹形式进行存储，日志分段对应了一个日志文件和两个索引文件及其他文件。关系图如下所示：</p><p><img src="'+r+'" alt="image-20221019082836554" loading="lazy"></p><p>某一个分区目录下文件内容如下图所示：</p><p><img src="'+t+'" alt="image-20221024225501769" loading="lazy"></p><h2 id="日志文件格式演变" tabindex="-1"><a class="header-anchor" href="#日志文件格式演变" aria-hidden="true">#</a> 日志文件格式演变</h2><p>Kafka的消息格式也经历了3个版本：v0版本、v1版本和v2版本。</p><h3 id="v0" tabindex="-1"><a class="header-anchor" href="#v0" aria-hidden="true">#</a> v0</h3><p>v0格式如下图所示：</p><p><img src="'+d+'" alt="image-20221024230009818" loading="lazy"></p><p>左边的RECORD部分就是v0版本的消息格式，offset是逻辑值，而非实际物理偏移值，message size表示消息的大小，这两者在一起被称为日志头部。日志头部和RECORD一起用来描述一条消息。相关字段解释如下：</p><ul><li>crc32（4B）：crc32校验值。校验范围为magic至value之间</li><li>magic（1B）：消息格式版本号，此版本的magic值为0</li><li>attributes（1B）：消息的属性。总共占1个字节，低3位表示压缩类型：0表示NONE、1表示GZIP、2表示SNAPPY、3表示LZ4（LZ4自Kafka 0.9.x引入），其余位保留。</li><li>key length（4B）：表示消息的key的长度。如果为-1，则表示没有设置key，即key=null。</li><li>key：可选，如果没有key则无此字段。</li><li>value length（4B）：实际消息体的长度。如果为-1，则表示消息为空。</li><li>value：消息体。可以为空，比如墓碑（tombstone）消息。</li></ul><p><strong>v0版本一个消息最小大小为14B</strong>。</p><h3 id="v1" tabindex="-1"><a class="header-anchor" href="#v1" aria-hidden="true">#</a> v1</h3><p>v1比v0版本就多了一个timestamp字段，表示消息的时间戳。v1版本的消息结构如下图所示。</p><p><img src="'+n+'" alt="image-20221024230550721" loading="lazy"></p><p><strong>v1版本的消息要比v0版本的大8个字节，即22B</strong>。</p><h3 id="v2" tabindex="-1"><a class="header-anchor" href="#v2" aria-hidden="true">#</a> v2</h3><div class="hint-container note"><p class="hint-container-title">前置知识</p><p>Varints(变长整形)是使用一个或多个字节来序列化整数的一种方法。数值越小，其占用的字节数就越少。Varints中的每个字节都有一个位于最高位的msb位（most significant bit），除最后一个字节外，其余msb位都设置为1，最后一个字节的msb位为0。这个msb位表示其后的字节是否和当前字节一起来表示同一个整数。除msb位外，剩余的7位用于存储数据本身，这种表示类型又称为Base 128。<strong>Varints中采用的是小端字节序，即最小的字节放在最前面。</strong></p><p>以296=256+32+8为例，对应的字节为 1010 1000 0000 0010,去掉msb位后结果为000 1000 000 0010，小端字节序转换后为 000 0010 000 1000 -&gt; 0000 0010 0000 1000 = 56+32+8。</p><p>ZigZag编码以一种锯齿形（zig-zags）的方式来回穿梭正负整数，将带符号整数映射为无符号整数，这样可以使绝对值较小的负数仍然享有较小的Varints编码值。</p><p>根据Varints的规则可以推导出0～63之间的数字占1个字节，64～8191之间的数字占2个字节，8192～1048575之间的数字占3个字节。</p></div><p>v2版本中消息集称为Record Batch，而不是先前的Message Set，其内部也包含了一条或多条消息，消息的格式如下图所示。</p><p><img src="'+o+'" alt="image-20221024233646064" loading="lazy"></p><p>消息格式Record的关键字段，可以看到内部字段大量采用了Varints，这样Kafka可以根据具体的值来确定需要几个字节来保存。大大节省了空间。</p><h2 id="日志索引" tabindex="-1"><a class="header-anchor" href="#日志索引" aria-hidden="true">#</a> 日志索引</h2><p>日志索引文件有偏移量索引文件和时间戳索引文件，Kafka 中的索引文件以稀疏索引（sparse index）的方式构造消息的索引，它并不保证每个消息在索引文件中都有对应的索引项。每当写入一定量（由 broker 端参数 <code>log.index.interval.bytes</code>指定，默认值为4096，即4KB）的消息时，偏移量索引文件和时间戳索引文件分别增加一个偏移量索引项和时间戳索引项，增大或减小<code>log.index.interval.bytes</code>的值，对应地可以增加或缩小索引项的密度。类似于跳表数据结构。</p><h2 id="日志清理" tabindex="-1"><a class="header-anchor" href="#日志清理" aria-hidden="true">#</a> 日志清理</h2><p>策略：</p><ul><li>日志删除：删除不符合条件的日志分段</li><li>日志压缩：针对每个消息的key进行整合，对于有相同key的不同value值，只保留最后一个版本。</li></ul><p>使用：</p><p>broker端设置参数<code>log.cleanup.policy</code>，默认为<code>delete</code>,即删除策略，要采用日志压缩，设置为<code>compact</code>。</p><h3 id="日志删除" tabindex="-1"><a class="header-anchor" href="#日志删除" aria-hidden="true">#</a> 日志删除</h3><p>在Kafka的日志管理器中会有一个专门的日志删除任务来周期性地检测和删除不符合保留条件的日志分段文件，这个周期可以通过broker端参数<code>log.retention.check.interval.ms</code>来配置，默认值为300000，即5分钟。当前日志分段的保留策略有3种：基于时间的保留策略、基于日志大小的保留策略和基于日志起始偏移量的保留策略。</p><h4 id="基于时间" tabindex="-1"><a class="header-anchor" href="#基于时间" aria-hidden="true">#</a> 基于时间</h4><p>通过broker端参数<code>log.retention.hours</code>、<code>log.retention.minutes</code>和<code>log.retention.ms</code>来配置，其中 <code>log.retention.ms</code> 的优先级最高，<code>log.retention.minutes</code> 次之，<code>log.retention.hours</code>最低。默认情况下只配置了<code>log.retention.hours</code>参数，其值为168，故默认情况下日志分段文件的保留时间为7天。</p><h4 id="基于日志大小" tabindex="-1"><a class="header-anchor" href="#基于日志大小" aria-hidden="true">#</a> 基于日志大小</h4><p>broker端参数<code>log.retention.bytes</code>来配置，默认值为-1，表示无穷大。注意<code>log.retention.bytes</code>配置的是Log中所有日志文件的总大小，而不是单个日志分段（确切地说应该为.log日志文件）的大小。单个日志分段的大小由 broker 端参数 <code>log.segment.bytes</code> 来限制，默认值为1073741824，即1GB。</p><h4 id="基于日志起始偏移量" tabindex="-1"><a class="header-anchor" href="#基于日志起始偏移量" aria-hidden="true">#</a> 基于日志起始偏移量</h4><p>如下图所示，日志分段1和日志分段2的起始偏移量小于logStartOffset，日志分段3的下一个日志偏移量比25大，所以日志分段3不会被删除，日志分段1和日志分段2将被删除。</p><p><img src="'+s+'" alt="image-20221025000251739" loading="lazy"></p><h3 id="日志压缩" tabindex="-1"><a class="header-anchor" href="#日志压缩" aria-hidden="true">#</a> 日志压缩</h3><p>对于有相同key的不同value值，只保留最后一个版本。如果应用只关心key对应的最新value值，则可以开启Kafka的日志清理功能，Kafka会定期将相同key的消息进行合并，只保留最新的value值。</p><h2 id="日志存储" tabindex="-1"><a class="header-anchor" href="#日志存储" aria-hidden="true">#</a> 日志存储</h2><p>Kafka使用磁盘存储消息。Kafka 在设计时采用了文件追加的方式来写入消息，即只能在日志文件的尾部追加新的消息，并且也不允许修改已写入的消息，这种方式属于顺序读写。顺序读写于随机读写相比随机读写来说速度快的多，保证Kafka的高吞吐量，除此以外，还有一些其他的方式保证它的高性能。</p><h3 id="页缓存" tabindex="-1"><a class="header-anchor" href="#页缓存" aria-hidden="true">#</a> 页缓存</h3><p>页缓存是操作系统实现的一种主要的磁盘缓存，以此用来减少对磁盘 I/O 的操作。具体来说，就是把磁盘中的数据缓存到内存中，把对磁盘的访问变为对内存的访问。</p><h3 id="零拷贝" tabindex="-1"><a class="header-anchor" href="#零拷贝" aria-hidden="true">#</a> 零拷贝</h3><p>除了消息顺序追加、页缓存等技术，Kafka还使用零拷贝技术来进一步提升性能。零拷贝是指将数据直接从磁盘文件复制到网卡设备中，而不需要经由应用程序之手。零拷贝大大提高了应用程序的性能，减少了内核和用户模式之间的上下文切换。</p>',49),h=[l];function p(g,m){return e(),a("div",null,h)}const v=A(c,[["render",p],["__file","06.Kafka日志存储.html.vue"]]);export{v as default};
