import{_ as s}from"./plugin-vue_export-helper-c27b6911.js";import{o as n,c as a,b as e}from"./app-ef0b4d9d.js";const o={},p=e(`<h2 id="数据库乐观锁扣减实现" tabindex="-1"><a class="header-anchor" href="#数据库乐观锁扣减实现" aria-hidden="true">#</a> 数据库乐观锁扣减实现</h2><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">## 方案1</span>
<span class="token keyword">update</span> product <span class="token keyword">set</span> stock<span class="token operator">=</span>stock<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> stock<span class="token operator">&gt;</span><span class="token number">0</span>

<span class="token comment">## 方案2</span>
<span class="token keyword">update</span> product <span class="token keyword">set</span> stock<span class="token operator">=</span>stock<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">where</span> stock<span class="token operator">=</span><span class="token comment">#{原先查询的库存}  and id = 1 and stock&gt;0</span>

<span class="token comment">## 方案3</span>
<span class="token keyword">update</span> product <span class="token keyword">set</span> stock<span class="token operator">=</span>stock<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>versioin <span class="token operator">=</span> version<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">where</span>  id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> stock<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">and</span> version<span class="token operator">=</span><span class="token comment">#{原先查询的版本号} </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方案一：id是主键索引的前提下，如果每次只是减少1个库存，则可以采用上面的方式，只做数据安全校验，可以有效减库存，性能更高，避免大量无用sql，只要有库存就也可以操作成功.<br> 场景：高并发场景下的取号器，优惠券发放扣减库存等</p><p>方案二：使用业务自身的条件做为乐观锁，但是存在ABA问题，对比方案三的好处是不用增加version版本字段。如果只是扣减库存且不在意ABA问题时，则可以采用上面的方式，但业务性能相对方案一就差了点，因为库存变动后sql就会无效</p><p>方案三：增加版本号主要是为了解决ABA问题，数据读取后，更新前数据被别人篡改过，version只能做递增<br> 场景：商品秒杀、优惠券方法，需要记录库存操作前后的业务</p>`,5),t=[p];function r(c,l){return n(),a("div",null,t)}const i=s(o,[["render",r],["__file","01.高并发下库存扣减.html.vue"]]);export{i as default};
